name: ğŸš€ CI/CD - Test & Deploy to Firebase

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Test job - runs on all pushes and PRs
  test:
    name: ğŸ§ª Run Tests & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          npm install -g firebase-tools
          # Add other dependencies if needed
          # npm install
      
      - name: ğŸ” Lint JavaScript files
        run: |
          # Basic JavaScript syntax check
          node -c app.js
          echo "âœ… JavaScript syntax check passed"
      
      - name: ğŸ§ª Run basic tests
        run: |
          # Test if HTML is valid
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "âŒ HTML DOCTYPE missing"
            exit 1
          fi
          
          # Test if Firebase config exists
          if ! grep -q "firebaseConfig" app.js; then
            echo "âŒ Firebase config not found"
            exit 1
          fi
          
          # Test if game canvas exists
          if ! grep -q "game-canvas" index.html; then
            echo "âŒ Game canvas element missing"
            exit 1
          fi
          
          echo "âœ… All basic tests passed"
      
      - name: ğŸ”’ Security scan
        run: |
          # Check for common security issues
          if grep -r "eval(" . --include="*.js"; then
            echo "âš ï¸ Warning: eval() usage detected"
          fi
          
          if grep -r "innerHTML.*+" . --include="*.js"; then
            echo "âš ï¸ Warning: Potential XSS vulnerability with innerHTML"
          fi
          
          echo "âœ… Security scan completed"

  # Deploy job - only runs on main branch pushes
  deploy:
    name: ğŸš€ Deploy to Firebase Hosting
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: ğŸ”¨ Build project (if needed)
        run: |
          # Add build steps here if you have a build process
          echo "âœ… Build completed (no build process configured)"
      
      - name: ğŸš€ Deploy to Firebase Hosting
        run: |
          firebase deploy --only hosting --token "${{ secrets.FIREBASE_TOKEN }}" --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: ğŸ“ Create deployment comment
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            const { context } = require('@actions/github');
            const deployUrl = 'https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app';
            
            // Create a comment on the commit (if it's a push)
            if (context.eventName === 'push') {
              console.log('ğŸ‰ Deployment successful!');
              console.log(`ğŸ”— Live URL: ${deployUrl}`);
            }

  # Performance audit job - runs after deployment
  lighthouse:
    name: ğŸ” Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x
      
      - name: ğŸ” Run Lighthouse audit
        run: |
          # Wait for deployment to be ready
          sleep 30
          
          # Run Lighthouse audit
          lhci autorun --collect.url=https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app || echo "Lighthouse audit completed"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notification job - sends status updates
  notify:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Success notification
        if: needs.test.result == 'success' && needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ”— Live URL: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo "ğŸ“± Test cross-device functionality with your mobile device"
      
      - name: âŒ Failure notification
        if: needs.test.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check the logs above for details"
          exit 1